{% extends 'index.html'%}
{% block content %}
{% load static %}


<!-- End Header -->
<section id="content">
	<div class="content-page">
		<div class="container">
			<div class="content-about content-checkout-page woocommerce">
				<h2 class="title30 play-font font-bold text-uppercase text-center dark">Checkout</h2>
				<div class="row">
					<form id="checkout-form" class="form-my-account  ">
						{% csrf_token %}
						<div class="col-md-12 col-sm-12 col-xs-12">
							<div class="row">
								<div class="col-md-12 col-sm-12 col-ms-12">
									<div class="check-billing">
										<!-- <form class="form-my-account" method="POST" action="{% url 'place_order' %}"> -->
										<!-- {% csrf_token %} -->

										<h2 class="title title18 font-bold text-uppercase">Billing Details</h2>
										<a href="{% url 'userAddAddress' %}" class="shop-button white mx-auto bg-dark"
											role="button"> Add new Address</a>

										{% if address %}
										{% for i in address %}
										<div class="card">
											<!-- <h5 class="card-header title title18 font-bold text-uppercase">Billing Details</h5> -->

											<div class="card-body">
												<input type="radio"  value="{{ i.id }}" name="address"
													class="address float-left  mr-2" style="height:2rem;width:1rem;">
												<!-- <h5 class="card-title">Special title treatment</h5> -->
												<!-- <p class="card-text px-5">{{i.Address}}</p> -->
												<p class="desc">{{i.fname}} {{i.lname}}</p>
												<p class="desc">{{i.Address}}</p>
												<p class="desc">{{i.city}},{{i.state}},{{i.country}},{{i.pincode}}</p>
												<!-- <a href="#" class="btn btn-primary">Go somewhere</a> -->
											</div>
										</div>
										<br>

										{% endfor %}

										{% else %}
										
		
										
										{% endif %}
										
									</div>
								</div>
								<div class=" new col-md-12 col-sm-12 col-ms-12">
									<div class="check-address">
										<!-- <form class="form-my-account" method="POST">  -->
										<!-- {% csrf_token %} -->
										<!-- <p class="ship-address">
												<input type="checkbox"  id="address" /> <label for="address">Ship to a different address?</label>
											</p> -->
										<!-- <p>
												<textarea cols="30" rows="10" name="address_line_2" onblur="if (this.value=='') this.value = this.defaultValue" onfocus="if (this.value==this.defaultValue) this.value = ''">Address</textarea>
											</p> -->
										<p class="ship-address">
											<label for="address">Order Notes</label>
										</p>
										<p>
											<textarea cols="20" rows="6" name="order_note"
												onblur="if (this.value=='') this.value = this.defaultValue"
												onfocus="if (this.value==this.defaultValue) this.value = ''">Order Notes</textarea>
										</p>
										<!-- </form> -->
									</div>
								</div>
							</div>
                            
                     <!----Display coupon-->
							<div class="box-best-seller9">
				
								<div class="tab-content">
									<div id="tab1" class="tab-pane active">
										<div class="product-slider">
											{% if coupons %}
												<h3 style="text-align: center;">Available Coupons</h3>
											<div class="wrap-item hide-navi" data-pagination="false" data-navigation="true" data-itemscustom="[[0,1],[560,2],[768,3],[990,4]]">
												
													
												{% for i in coupons %}	
												
												<div class="item-product item-product4 bg-light text-center">
										
													
													<div class="product-thumb bg-white">
														<h3 class="card-title">{{i.discount}}%</h3>
														<!-- <h6 class="card-subtitle mb-2 text-muted">{{i.coupon_name}}</h6> -->
														<h4 class="card-title" > Use Code : <b>{{i.coupon_code}}</b></h4>
								  
													</div>


													<div class="product-info">
														<!-- <h3 class="title14 product-title">{{i.discount}}%</h3> -->
														<div class="product-price title14 play-font">

															<p class="card-text">Valid From :{{i.valid_from}}</p>
															<p class="card-text" style="color: grey;"> Expires :{{i.valid_to}}</p>
													
														</div>
														
														
													</div>
												
												</div>
													{%  endfor  %}
													{% else %}
													<h3>
														No Coupons Available
													</h3>

													{% endif %}
												
											</div>	
										</div>	
									</div>	
								</div>	
								</div>

								<!----End coupon-->





							<p  id="status" style="color: red;justify-content: center;">
								{{status}}
							</p>
							<div style="display: flex;justify-content: center;" class="mx-auto">
								
								{% if not Coupon %}
								{% for i in messages %}
								<p  style="color: red;">
									{{i}}
								</p>
								{% endfor %}
							
								<!-- <a href="{% url 'viewcoupon' %}" name="update_cart" role="button" class="button btn-dark " style="margin-right: 8rem;">	View Coupons</a> -->

								{% else %}
								<button name="update_cart" class="button btn-dark" onclick="removeCoupon()">	Delete Coupon</button>

								{% endif %}
							    <div class="coupon" style="display: flex;" class="">

									<!-- <label for="coupon_code">Coupon:</label>  -->
									<input type="text" placeholder="Coupon code" value="" id="coupon_code" class="button  input-text" name="coupon_code" style="width: 100%; height: 5rem;"> 
									<input type="button" value="Apply Coupon" onclick="applycoupon()" name="apply_coupon" class="button btn-dark" style="margin-left: 8rem;">
								</div>
								<!-- <a href="{% url 'viewcoupon' %}" name="update_cart" role="button" class="button btn-dark">	View Coupons</a> -->
							</div>

							<h3 class="order_review_heading bg-dark text-center">Your order</h3>
							<div class="woocommerce-checkout-review-order" id="order_review">
								<div class="table-responsive">
									<table class="shop_table woocommerce-checkout-review-order-table">
										<thead>
											<tr>
												<th class="product-name">Product</th>
												<th class="product-total">Total</th>
											</tr>
										</thead>
										<tbody>
											{% for i in cart_item %}
											<tr class="cart_item">
												<td class="product-name">
													{{i.product.product_name}}<span class="product-quantity"> *
														{{i.quantity}}</span>
												</td>
												<td class="product-total">
													<span class="amount">₹{{i.sub_total}}</span>
												</td>
											</tr>
											{% endfor %}
											
											<!-- <tr class="cart_item">
												<td class="product-name">
													Theme Fusion item name <span class="product-quantity">× 2</span>
												</td>
												<td class="product-total">
													<span class="amount">$38.00</span>
												</td>
											</tr> -->
										</tbody>
										<tfoot>
											<tr class="cart-subtotal">
												<th>Subtotal</th>
												<td><strong class="amount" >₹{{total}}</strong></td>
												<input type="hidden" name="total" id="total" value="{{total}}">

											</tr>
											<tr class="cart-subtotal">
												<th>Coupon Code</th>
												<td><strong class="amount" id="Coupon_code">{{Coupon_code}}</strong></td>
											</tr>

											<tr class="cart-subtotal">
												<th>Coupon</th>
												<td><strong class="amount" id="Coupon">₹{{Coupon}}</strong></td>
											</tr>
											<tr class="cart-subtotal">
												<th>Tax</th>
												<td><strong class="amount" >₹{{tax}}</strong></td>
												<input type="hidden" name="total" id="tax" value="{{tax}}">

											</tr>

											
											<!---<tr class="shipping">
												<th>Shipping</th>
												<td>
													<ul class="list-none" id="shipping_method">
														<li>
															<input type="radio" class="shipping_method" checked="checked" value="free_shipping" id="shipping_method_0_free_shipping" data-index="0" name="shipping_method[0]">
															<label for="shipping_method_0_free_shipping">Free Shipping</label>
														</li>
														<li>
															<input type="radio" class="shipping_method" value="local_delivery" id="shipping_method_0_local_delivery" data-index="0" name="shipping_method[0]">
															<label for="shipping_method_0_local_delivery">Local Delivery (Free)</label>
														</li>
														
													</ul>
												</td>
											</tr>---->
											<tr class="order-total">
												<th>Total</th>
												<td><strong><span class="amount" id="grand_total">₹{{grand_total}}</span></strong> </td>
											</tr>
			
										</tfoot>
									</table>
								</div>
								
								<div class="woocommerce-checkout-payment" id="payment">
									<!-- <ul class="payment_methods methods list-none"> -->

									

									<!-- <li class="payment_method_cod"> -->
									<!-- <a class="btn btn-dark" href="{% url 'place_order' %}" role="button">Cash on Delivery</a> -->

									<!-- <input type="radio" data-order_button_text="" value="cod" name="cash" class="input-radio" id="payment_method_cod"> -->
									<!-- <label for="payment_method_cod">Cash on Delivery 	</label> -->

									<!-- <div style="display:none;" class="payment_box payment_method_cod">
												<p>Pay with cash upon delivery.</p>
											</div> -->
									<!-- </li> -->

									<!-- <li class="payment_method_paypal"> -->

									<!-- <a class="btn btn-dark" href="{% url 'user_shop' %}" role="button">Pay with RazorPay</a> -->

									<!-- <input type="radio" data-order_button_text="Proceed to PayPal" value="paypal" name="payment_method" class="input-radio" id="payment_method_paypal">
											<label for="payment_method_paypal">
												PayPal <img alt="PayPal Acceptance Mark" src="{% static 'images/page/payment.png' %}"><a title="What is PayPal?" onclick="javascript:window.open('https://www.paypal.com/gb/webapps/mpp/paypal-popup','WIPaypal','toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=1060, height=700'); return false;" class="about_paypal" href="https://www.paypal.com/gb/webapps/mpp/paypal-popup">What is PayPal?</a>	
											</label>
											<div style="display:none;" class="payment_box payment_method_paypal">
												<p>Pay via PayPal; you can pay with your credit card if you don’t have a PayPal account.</p> -->
									<!-- </div> -->
									<!-- </li> -->
									<!-- </ul> -->
									<div class="form-row place-order">
										<!-- <a href="{% url 'place_order' %}">---->
										<!-- <input type="submit" data-value="Place order" value="Place order" id="place_order" name="woocommerce_checkout_place_order" class="button alt bg-color"> -->
										<!-- <button type="submit">Place order</button> -->
										<button class="btn btn-dark payWithRazorpay"  type="button" >Pay with  RazorPay</button>
										<button class="btn btn-dark" type="submit" >Cash on
											Delivery</button>
											<input type="hidden" value="COD" name="pay_mode">

										<!-- </a> -->
									</div>
								</div>
							</div>
						</div>
						{{form.errors}}
					</form>
				</div>

			</div>
		</div>
	</div>

	<!-- End Content Pages -->
</section>

<script >

	$(document).ready(function () {

		$("#checkout-form").submit((e) => {
			e.preventDefault();
			var address = $("[name='address']:checked").val(); // get selected address
			 if (!address) { // check if an address is selected
					console.log(address,'Mwonuseee evide und.....');
					Swal.fire('Error', 'Please select an address.', 'error'); // display error message
					return false;
				}
			
			Swal.fire({
				title: 'Are you sure?',
				text: "You won't be able to revert this!",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: 'Yes'
			}).then((result) => {
				if (result.isConfirmed) {
					
					$.ajax({
						url: "{% url 'place_order' %}",
						method: "post",
						headers: {
							'X-CSRFToken': '{{ csrf_token }}'
						},
						data: $("#checkout-form").serialize()
					}).done((res) => {
						console.log(res)
						Swal.fire(
							'Successfull!',
							'Your order has been placed.',
							'success'
						).then(() =>{
							location.href = '/userptofile/orderDetails/'+res.id
						})
					}).fail((err) => {

					})

				}
			})
		})
		
	})

	function applycoupon() {
    var coupon_code=document.getElementById('coupon_code').value
    var grand_total=document.getElementById('total').value
    var tax=document.getElementById('tax').value
	console.log(coupon_code)
	if (!coupon_code) { // check if an address is selected
					console.log(coupon_code,'Mwonuseee evide und.....');
					Swal.fire('Error', 'Please enter  a coupon code', 'error'); // display error message
					return false;
				}
	console.log("total",grand_total)
    console.log("tax",tax)
    $.ajax({
        url:"{% url 'apply_coupon' %}",
        method:"GET",
        data:{
            coupon_code:coupon_code,
            grand_total:grand_total,
			tax:tax,
        },
        success:(r) =>{
			console.log(r.Coupon,'jhjhhjjhjhj')
            $('#grand_total').text("₹"+r.grand_total)
            $('#Coupon').text("₹"+r.Coupon)
            $('#Coupon_code').text("₹"+r.Coupon_code)
            $('#status').text(r.status)
        }

    })
}


function removeCoupon() {
	event.preventDefault()
    console.log("remove Coupon")
	Swal.fire({
                title : 'Are you sure you want to remove coupon?',
                text:'You can reuse after removing the coupon!',
                icon:'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor:'#d33',
                confirmButtonText:'Yes'
    }).then((result)=>{
                if(result.isConfirmed){
    					$.ajax({
       						url:"{% url 'delete_coupon' %}",
      						method:"GET",
        					data:{
          				 	'0':0,
        			},
       				 success:(r) =>{
					window.location="{% url 'checkout' %}"                            

       				 }
					});
				}

  		  })
		}


	// window.history.forward();
	// function preventBack() {
	//   window.history.forward();
	// }
	// setTimeout("preventBack()", 10);
	// window.onunload = function() {
	//   window.replace('/');
	// };
</script>
<!-- <script>
	window.history.forward();
	function preventBack() {
	  window.history.forward();
	}
	setTimeout("preventBack()", 10);
	window.onunload = function() {
	  window.replace('/');
	};
      </script> -->

{% endblock  %}

{% block scripts %}
<!-- <script src="{% static '/js/coupon.js' %}"></script>--Custome js file for cart quantity validation -->

{% endblock scripts %}
<!-- 

<script src="https://checkout.razorpay.com/v1/checkout.js"></script> -->

<!-- <script src="https://checkout.razorpay.com/v1/checkout.js"></script> --
<!-- End Content -->